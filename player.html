<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pigiama Party - Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --pink: #ff00c8;
            --cyan: #00eaff;
            --purple: #7b2cff;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Orbitron', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #000 0%, #0e0030 100%);
            color: white;
            padding: 20px;
            text-align: center;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        h1 {
            background: linear-gradient(90deg, var(--pink), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
            font-size: 2rem;
        }

        .game-code {
            font-size: 2rem;
            font-weight: bold;
            color: var(--cyan);
            margin: 20px 0;
            padding: 15px;
            border: 2px solid var(--cyan);
            border-radius: 10px;
            display: inline-block;
        }

        .btn {
            padding: 12px 25px;
            margin: 10px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(90deg, var(--pink), var(--purple));
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 0, 128, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-field {
            padding: 12px 15px;
            margin: 10px 0;
            border: 2px solid var(--cyan);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            width: 100%;
            max-width: 300px;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .question-container {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid var(--pink);
        }

        .question-text {
            font-size: 1.3rem;
            margin: 15px 0;
            line-height: 1.4;
        }

        .timer {
            font-size: 2.5rem;
            color: var(--cyan);
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .answers-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .answer-btn {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--cyan);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .answer-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .waiting-message {
            font-size: 1.2rem;
            margin: 30px 0;
            color: var(--cyan);
        }

        .leaderboard-container {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid var(--gold);
        }

        .leaderboard-list {
            list-style: none;
            margin: 20px 0;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid var(--cyan);
        }

        .rank {
            font-weight: bold;
            width: 40px;
            text-align: center;
        }

        .name {
            flex: 1;
            text-align: left;
            padding: 0 15px;
        }

        .score {
            font-weight: bold;
            color: var(--cyan);
        }

        /* ANIMAZIONI SCHERMATE */
        .screen {
            animation: screenEnter 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes screenEnter {
            0% { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }

        .hidden {
            display: none;
        }

        /* EFFETTI TIMER */
        .timer.warning {
            color: #ff4444;
            text-shadow: 0 0 20px #ff4444;
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        /* EFFETTO RISPOSTA CORRETTA */
        .answer-option.correct {
            background: rgba(0, 255, 100, 0.2);
            border-color: #00ff88;
            animation: correctGlow 0.6s ease;
        }

        @keyframes correctGlow {
            0% { box-shadow: 0 0 0px #00ff88; }
            50% { box-shadow: 0 0 30px #00ff88; }
            100% { box-shadow: 0 0 0px #00ff88; }
        }

        /* EFFETTO RISPOSTA SELEZIONATA */
        .answer-btn.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        /* VERSION INFO */
        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* AUDIO CONTROLS */
        .audio-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .audio-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--cyan);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .audio-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <!-- CONTROLLO AUDIO PLAYER -->
    <div class="audio-controls">
        <button class="audio-btn" id="sfxToggle">üîä Suoni</button>
    </div>

    <div class="version">v2.5 - Transizioni & Suoni</div>
    
    <div class="container">
        <!-- SCHERMATA INIZIALE -->
        <div id="initialScreen" class="screen">
            <h1>üéÆ PIGIAMA PARTY</h1>
            <p style="margin: 20px 0; opacity: 0.8;">Inserisci il codice del gioco e il tuo nome</p>
            
            <input type="text" id="gameCodeInput" class="input-field" placeholder="Codice Gioco" maxlength="8">
            <input type="text" id="playerName" class="input-field" placeholder="Il Tuo Nome" maxlength="20">
            
            <button class="btn" id="joinBtn">UNISCITI AL GIOCO</button>
        </div>

        <!-- SCHERMATA ATTESA -->
        <div id="waitingScreen" class="screen hidden">
            <h1>üéÆ IN ATTESA</h1>
            <div class="game-code" id="gameCodeDisplay">GAME123</div>
            <div class="waiting-message" id="waitingMessage">
                In attesa che l'host inizi il gioco...
            </div>
            <div style="margin: 20px 0;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; display: inline-block;">
                    <div style="font-weight: bold;">Giocatore:</div>
                    <div style="font-size: 1.2rem; font-weight: bold;" id="playerNameDisplay">Nome Giocatore</div>
                </div>
            </div>
        </div>

        <!-- SCHERMATA DOMANDA -->
        <div id="questionScreen" class="screen hidden">
            <div class="question-container">
                <div id="questionNumber" style="color: var(--cyan); font-weight: bold; margin-bottom: 10px;">Domanda 1/3</div>
                <div class="question-text" id="questionText">La domanda apparir√† qui...</div>
                <div class="timer" id="timer">20</div>
                
                <div class="answers-container" id="answersContainer">
                    <!-- Le risposte appariranno qui -->
                </div>
                
                <button class="btn" id="submitBtn" disabled>INVIA RISPOSTA</button>
            </div>
        </div>

        <!-- SCHERMATA RISPOSTA INVIATA -->
        <div id="answerSubmittedScreen" class="screen hidden">
            <h1>‚úÖ RISPOSTA INVIATA!</h1>
            <div class="waiting-message">
                Attendi gli altri giocatori...
            </div>
            <div style="margin: 20px 0;">
                <div style="background: rgba(0,255,100,0.1); padding: 15px; border-radius: 10px; display: inline-block; border: 2px solid #00ff88;">
                    <div style="font-weight: bold;">Hai selezionato:</div>
                    <div style="font-size: 1.2rem; font-weight: bold;" id="selectedAnswerText">Risposta</div>
                </div>
            </div>
        </div>

        <!-- SCHERMATA CLASSIFICA -->
        <div id="leaderboardScreen" class="screen hidden">
            <div class="leaderboard-container">
                <h2 style="font-size: 2rem; margin-bottom: 20px;">üèÜ CLASSIFICA</h2>
                
                <ul class="leaderboard-list" id="leaderboardList">
                    <!-- La classifica verr√† generata qui -->
                </ul>

                <div style="margin-top: 20px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;">
                        <div style="font-weight: bold;">Il tuo punteggio:</div>
                        <div style="font-size: 1.5rem; color: var(--cyan); font-weight: bold;" id="playerScore">0 punti</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ELEMENTI AUDIO - SOLO SUONI (NO MUSICA) -->
    <audio id="clickSound" preload="auto">
        <source src="audio/click.mp3" type="audio/mpeg">
    </audio>
    <audio id="correctSound" preload="auto">
        <source src="audio/correct.mp3" type="audio/mpeg">
    </audio>
    <audio id="wrongSound" preload="auto">
        <source src="audio/wrong.mp3" type="audio/mpeg">
    </audio>
    <audio id="transitionSound" preload="auto">
        <source src="audio/transition.mp3" type="audio/mpeg">
    </audio>
    <audio id="timerSound" preload="auto">
        <source src="audio/timer.mp3" type="audio/mpeg">
    </audio>
    <audio id="submitSound" preload="auto">
        <source src="audio/start.mp3" type="audio/mpeg">
    </audio>

    <script>
        // === FORZA REFRESH CACHE ===
        console.log('üéÆ PLAYER v2.5 - Transizioni & Suoni - Caricato: ' + new Date().toLocaleString());

        // === SISTEMA AUDIO SEMPLIFICATO (SOLO SUONI) ===
        const audio = {
            // Sound Effects
            clickSound: document.getElementById('clickSound'),
            correctSound: document.getElementById('correctSound'),
            wrongSound: document.getElementById('wrongSound'),
            transitionSound: document.getElementById('transitionSound'),
            timerSound: document.getElementById('timerSound'),
            submitSound: document.getElementById('submitSound'),
            
            // Stato
            sfxEnabled: true,
            audioActivated: false,
            
            // Metodi
            async activateAudio() {
                console.log('üéµ Attivazione audio player...');
                
                try {
                    // Sblocca l'audio con un suono quasi silenzioso
                    this.clickSound.volume = 0.01;
                    await this.clickSound.play();
                    this.clickSound.pause();
                    this.clickSound.currentTime = 0;
                    
                    this.audioActivated = true;
                    console.log('üéµ Audio player attivato!');
                    
                } catch (error) {
                    console.error('‚ùå Errore attivazione audio player:', error);
                    this.audioActivated = true; // Fallback
                }
            },
            
            async playSFX(type) {
                if (!this.sfxEnabled || !this.audioActivated) {
                    console.log('üîá SFX disabilitati o audio non attivato');
                    return;
                }
                
                try {
                    const sfx = this[type];
                    sfx.currentTime = 0;
                    sfx.volume = 0.6;
                    await sfx.play();
                    console.log('üîä SFX player:', type);
                } catch (error) {
                    console.error('‚ùå Errore SFX player:', error);
                }
            },
            
            toggleSFX() {
                this.sfxEnabled = !this.sfxEnabled;
                const toggleBtn = document.getElementById('sfxToggle');
                toggleBtn.textContent = this.sfxEnabled ? 'üîä Suoni' : 'üîá Suoni';
                console.log(this.sfxEnabled ? 'üîä Suoni player ON' : 'üîá Suoni player OFF');
            }
        };

        // === CONFIGURA FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyC-RrLKSwfM-S5r1gD_RWdjWElWhkgp1vI",
            authDomain: "pigiamaparty2-b8d66.firebaseapp.com",
            databaseURL: "https://pigiamaparty2-b8d66-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pigiamaparty2-b8d66",
            storageBucket: "pigiamaparty2-b8d66.firebasestorage.app",
            messagingSenderId: "300420666102",
            appId: "1:300420666102:web:4170ec1ba37673b88652d7"
        };

        // Inizializza Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // === VARIABILI DI STATO ===
        let gameCode = '';
        let playerName = '';
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let timeLeft = 20;
        let timer;
        let playerScore = 0;

        // === ELEMENTI DOM ===
        const elements = {
            initialScreen: document.getElementById('initialScreen'),
            waitingScreen: document.getElementById('waitingScreen'),
            questionScreen: document.getElementById('questionScreen'),
            answerSubmittedScreen: document.getElementById('answerSubmittedScreen'),
            leaderboardScreen: document.getElementById('leaderboardScreen'),
            gameCodeInput: document.getElementById('gameCodeInput'),
            playerName: document.getElementById('playerName'),
            joinBtn: document.getElementById('joinBtn'),
            gameCodeDisplay: document.getElementById('gameCodeDisplay'),
            waitingMessage: document.getElementById('waitingMessage'),
            playerNameDisplay: document.getElementById('playerNameDisplay'),
            questionNumber: document.getElementById('questionNumber'),
            questionText: document.getElementById('questionText'),
            timer: document.getElementById('timer'),
            answersContainer: document.getElementById('answersContainer'),
            submitBtn: document.getElementById('submitBtn'),
            selectedAnswerText: document.getElementById('selectedAnswerText'),
            leaderboardList: document.getElementById('leaderboardList'),
            playerScore: document.getElementById('playerScore')
        };

        // === FUNZIONI PRINCIPALI ===
        function showScreen(screenId) {
            // Nascondi tutte le schermate
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // Mostra la schermata richiesta con animazione
            setTimeout(() => {
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    audio.playSFX('transitionSound');
                }
            }, 50);
        }

        function joinGame() {
            gameCode = elements.gameCodeInput.value.trim().toUpperCase();
            playerName = elements.playerName.value.trim();
            
            if (!gameCode || !playerName) {
                alert('Inserisci sia il codice gioco che il tuo nome!');
                return;
            }

            audio.playSFX('clickSound');
            
            // Aggiorna UI
            elements.gameCodeDisplay.textContent = gameCode;
            elements.playerNameDisplay.textContent = playerName;
            
            // Connetti al gioco
            database.ref('games/' + gameCode + '/players').push({
                name: playerName,
                joinedAt: Date.now()
            });

            // Ascolta lo stato del gioco
            database.ref('games/' + gameCode).on('value', (snapshot) => {
                const game = snapshot.val();
                if (!game) {
                    alert('Gioco non trovato! Controlla il codice.');
                    return;
                }

                if (game.status === 'started') {
                    showQuestionScreen();
                } else if (game.status === 'ended') {
                    showLeaderboard(game.leaderboard || []);
                }
            });

            // Ascolta le domande
            database.ref('games/' + gameCode + '/currentQuestionData').on('value', (snapshot) => {
                const question = snapshot.val();
                if (question) {
                    showQuestion(question);
                }
            });

            showScreen('waitingScreen');
        }

        function showQuestionScreen() {
            audio.playSFX('transitionSound');
            showScreen('questionScreen');
        }

        function showQuestion(question) {
            // Reset stato
            selectedAnswer = null;
            elements.submitBtn.disabled = true;
            elements.submitBtn.textContent = 'INVIA RISPOSTA';
            
            // Aggiorna UI
            elements.questionText.textContent = question.question;
            elements.questionNumber.textContent = `Domanda ${currentQuestionIndex + 1}`;
            
            // Pulisci e ricrea risposte
            elements.answersContainer.innerHTML = '';
            question.answers.forEach((answer, index) => {
                const button = document.createElement('button');
                button.className = 'answer-btn';
                button.textContent = answer;
                button.onclick = () => selectAnswer(index, answer);
                elements.answersContainer.appendChild(button);
            });
            
            showScreen('questionScreen');
            startTimer();
        }

        function selectAnswer(index, answerText) {
            audio.playSFX('clickSound');
            
            // Rimuovi selezione precedente
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Aggiungi selezione corrente
            document.querySelectorAll('.answer-btn')[index].classList.add('selected');
            selectedAnswer = index;
            elements.submitBtn.disabled = false;
            
            // Salva il testo per la schermata di conferma
            elements.selectedAnswerText.textContent = answerText;
        }

        function submitAnswer() {
            if (selectedAnswer === null) return;
            
            audio.playSFX('submitSound');
            elements.submitBtn.disabled = true;
            elements.submitBtn.textContent = '‚úì INVIA';
            
            // Invia risposta a Firebase
            database.ref('games/' + gameCode + '/answers').push({
                playerName: playerName,
                answerIndex: selectedAnswer,
                questionIndex: currentQuestionIndex,
                answerTime: timeLeft
            });

            // Mostra schermata di conferma
            setTimeout(() => {
                showScreen('answerSubmittedScreen');
            }, 500);
        }

        function startTimer() {
            timeLeft = 20;
            elements.timer.textContent = timeLeft;
            elements.timer.classList.remove('warning');
            
            clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                elements.timer.textContent = timeLeft;
                
                // Effetto timer che scade
                if (timeLeft <= 5) {
                    elements.timer.classList.add('warning');
                    if (timeLeft <= 3) {
                        audio.playSFX('timerSound');
                    }
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    // Auto-invia risposta se selezionata
                    if (selectedAnswer !== null) {
                        submitAnswer();
                    } else {
                        showScreen('answerSubmittedScreen');
                    }
                }
            }, 1000);
        }

        function showLeaderboard(leaderboard) {
            audio.playSFX('transitionSound');
            
            // Aggiorna classifica
            elements.leaderboardList.innerHTML = '';
            
            leaderboard.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                
                // Aggiungi icone per i primi 3
                let rankIcon = '';
                if (index === 0) rankIcon = 'ü•á ';
                else if (index === 1) rankIcon = 'ü•à ';
                else if (index === 2) rankIcon = 'ü•â ';
                
                li.innerHTML = `
                    <span class="rank">${rankIcon}${index + 1}¬∞</span>
                    <span class="name">${player.name}</span>
                    <span class="score">${player.score || 0}p</span>
                `;
                elements.leaderboardList.appendChild(li);
                
                // Aggiorna punteggio del giocatore corrente
                if (player.name === playerName) {
                    playerScore = player.score || 0;
                    elements.playerScore.textContent = `${playerScore} punti`;
                }
            });
            
            showScreen('leaderboardScreen');
        }

        // === EVENT LISTENERS ===
        elements.joinBtn.addEventListener('click', joinGame);
        elements.submitBtn.addEventListener('click', submitAnswer);

        // Attiva audio al primo click
        document.addEventListener('click', function initAudio() {
            if (!audio.audioActivated) {
                audio.activateAudio();
            }
        }, { once: true });

        // Controllo audio
        document.getElementById('sfxToggle').addEventListener('click', function() {
            audio.toggleSFX();
        });

        // Invio con Enter
        elements.gameCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') joinGame();
        });
        elements.playerName.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') joinGame();
        });

        // === INIZIALIZZAZIONE ===
        console.log('üéÆ Player v2.5 pronto!');
        
        // Forza refresh visivo
        setTimeout(() => {
            document.title = "Pigiama Party - Player v2.5";
        }, 100);
    </script>
</body>
</html>
